# 2
# بازبینی کد – فرآیند و اهمیت (Code Review – Process and Importance)
انگیزه اصلی پشت هر بازبینی کد (code review)، بهبود کیفیت کلی کد است. کیفیت کد (Code quality) بسیار مهم است. این تقریباً ناگفته پیداست، به خصوص اگر کد شما بخشی از یک پروژه تیمی باشد یا برای دیگران، مانند توسعه‌دهندگان متن‌باز (open source developers) و مشتریان از طریق توافق‌نامه‌های امانی (escrow agreements)، قابل دسترسی باشد.

اگر هر توسعه‌دهنده‌ای آزاد بود تا هر طور که می‌خواهد کدنویسی کند، در نهایت با یک نوع کد مواجه می‌شدید که به روش‌های بسیار متفاوتی نوشته شده بود، و نهایتاً کد به یک آشفته‌بازار غیرقابل کنترل (unwieldy mess) تبدیل می‌شد. به همین دلیل مهم است که یک سیاست استانداردهای کدنویسی (coding standards policy) داشته باشیم که شیوه‌های کدنویسی شرکت و رویه بازبینی کد (code review procedures) را که باید رعایت شوند، تشریح کند.

هنگامی که بازبینی کد انجام می‌شود، همکاران کد یکدیگر را بازبینی خواهند کرد. همکاران درک خواهند کرد که اشتباه کردن فقط یک ویژگی انسانی است. آن‌ها کد را برای یافتن اشتباهات، کدنویسی‌ای که قوانین رفتار کدنویسی شرکت (company's code of coding conduct) را نقض می‌کند، و هر کدی که، در حالی که از نظر نحوی صحیح (syntactically correct) است، می‌تواند بهبود یابد تا یا خواناتر (more readable)، یا قابل نگهداری‌تر (more maintainable)، یا کارآمدتر (more performant) شود، بررسی خواهند کرد.


بنابراین، در این فصل، موضوعات زیر را برای درک جزئیات فرآیند بازبینی کد پوشش خواهیم داد:

+ آماده‌سازی کد برای بازبینی

+ رهبری یک بازبینی کد

+ دانستن اینکه چه چیزی را بازبینی کنیم

+ دانستن اینکه چه زمانی کد را برای بازبینی بفرستیم

+ ارائه و پاسخ به بازخورد بازبینی

لطفاً توجه داشته باشید که برای بخش‌های آماده‌سازی کد برای بازبینی و دانستن اینکه چه زمانی کد را برای بازبینی بفرستیم، از دیدگاه برنامه‌نویس (programmer) صحبت خواهیم کرد. برای بخش‌های رهبری یک بازبینی کد و دانستن اینکه چه چیزی را بازبینی کنیم، از دیدگاه بازبینی‌کننده کد (code reviewer) صحبت خواهیم کرد. با این حال، در مورد بخش ارائه و پاسخ به بازخورد بازبینی، دیدگاه‌های هر دو برنامه‌نویس و بازبینی‌کننده کد را پوشش خواهیم داد.

اهداف یادگیری این فصل این است که شما بتوانید کارهای زیر را انجام دهید:

+ بازبینی‌های کد و چرایی مفید بودن آن‌ها را درک کنید.

+ در بازبینی‌های کد شرکت کنید.

+ انتقاد سازنده (constructive criticism) ارائه دهید.

+ به انتقاد سازنده به طور مثبت پاسخ دهید.

قبل از اینکه عمیقاً به این موضوعات بپردازیم، بیایید فرآیند کلی بازبینی کد را درک کنیم.

## فرآیند بازبینی کد (The code review process)
رویه عادی برای انجام یک بازبینی کد این است که مطمئن شوید کد شما کامپایل (compiles) می‌شود و الزامات تعیین شده را برآورده می‌کند. همچنین باید تمام تست‌های واحد (unit tests) و تست‌های سرتاسری (end-to-end tests) را پاس کند. هنگامی که مطمئن شدید که می‌توانید کد خود را با موفقیت کامپایل، تست و اجرا کنید، سپس آن را در شاخه کاری فعلی (current working branch) چک‌این (checked in) می‌کنید. پس از چک‌این، شما یک درخواست کشیدن (pull request) صادر خواهید کرد.

یک بازبینی‌کننده همتا (peer reviewer) سپس کد شما را بازبینی کرده و نظرات و بازخوردها را به اشتراک خواهد گذاشت. اگر کد شما از بازبینی کد عبور کند، بازبینی کد شما تکمیل شده و سپس می‌توانید شاخه کاری خود را در شاخه اصلی (main trunk) ادغام (merge) کنید. در غیر این صورت، بازبینی همتا رد خواهد شد، و از شما خواسته می‌شود که کار خود را بازبینی کرده و مسائلی را که در نظرات ارائه شده توسط بازبینی‌کننده شما مطرح شده‌اند، برطرف کنید.


دیاگرام زیر فرآیند بازبینی کد همتا را نشان می‌دهد:
<div align="center">
  
  ![Conventions-UsedThis-Book](../../assets/image/02/Table%202-1.png) 
  
</div>

## آماده‌سازی کد برای بازبینی (Preparing code for review)
گاهی اوقات آماده‌سازی برای بازبینی کد (code review) می‌تواند یک دردسر واقعی باشد، اما قطعاً به بهبود کیفیت کلی کدی که خواندن و نگهداری آن آسان است، کمک می‌کند. این قطعاً یک روش ارزشمند است که تیم‌های توسعه‌دهنده باید آن را به عنوان رویه‌های استاندارد کدنویسی انجام دهند. این یک گام مهم در فرآیند بازبینی کد است، زیرا تکمیل این مرحله می‌تواند زمان و انرژی قابل توجهی را برای بازبینی‌کننده در انجام بازبینی صرفه‌جویی کند.

در اینجا چند نکته استاندارد وجود دارد که هنگام آماده‌سازی کد خود برای بازبینی باید در نظر داشته باشید:

+ همیشه بازبینی کد را در ذهن داشته باشید: هنگام شروع هر برنامه‌نویسی، باید بازبینی کد را در ذهن داشته باشید. بنابراین کد خود را کوچک نگه دارید. در صورت امکان، کد خود را به یک ویژگی محدود کنید.

+ اطمینان حاصل کنید که تمام تست‌های شما پاس می‌شوند حتی اگر کد شما بیلد شود: اگر کد شما بیلد (build) می‌شود اما تست‌های شکست‌خورده (failing tests) دارید، فوراً با چیزی که باعث شکست آن تست‌ها می‌شود، مقابله کنید. سپس، هنگامی که تست‌ها مطابق انتظار پاس می‌شوند، می‌توانید ادامه دهید. مهم است که اطمینان حاصل کنید که تمام تست‌های واحد (unit tests) پاس شده‌اند، و تست سرتاسری (end-to-end testing) تمام تست‌ها را پاس می‌کند. مهم است که تمام تست‌ها کامل شوند و چراغ سبز (green light) را دریافت کنند، زیرا انتشار کدی که کار می‌کند اما در تست شکست خورده بود، می‌تواند منجر به نارضایتی شدید مشتریان هنگام رفتن کد به تولید (production) شود.

+ YAGNI را به یاد داشته باشید: هنگام کدنویسی، مطمئن شوید که فقط کدی را اضافه می‌کنید که برای برآورده کردن الزام (requirement) یا ویژگی (feature) مورد نظر ضروری است. اگر هنوز به آن نیاز ندارید، آن را کدنویسی نکنید. فقط زمانی کد را اضافه کنید که به آن نیاز باشد و نه قبل از آن.

+ کد تکراری را بررسی کنید: اگر کد شما باید شی‌گرا (object-oriented) باشد و DRY و SOLID باشد، کد خود را بازبینی کنید تا ببینید آیا حاوی هیچ کد رویه‌ای (procedural) یا تکراری (duplicate code) است. اگر چنین است، وقت بگذارید و آن را بازسازی (refactor) کنید تا شی‌گرا، DRY و SOLID باشد.

+ از تحلیل‌گرهای استاتیک استفاده کنید: تحلیل‌گرهای کد استاتیک (Static code analyzers) که برای اعمال بهترین شیوه‌های شرکت (company's best practices) پیکربندی شده‌اند، کد شما را بررسی کرده و هر مشکلی را که با آن مواجه می‌شوند، برجسته می‌کنند. اطمینان حاصل کنید که اطلاعات و هشدارها را نادیده نمی‌گیرید. این‌ها می‌توانند در آینده برای شما مشکل ایجاد کنند.

مهم‌تر از همه، کد خود را فقط زمانی چک‌این (check in) کنید که مطمئن هستید کد شما الزامات تجاری (business requirements) را برآورده می‌کند، به استانداردهای کدنویسی (coding standards) پایبند است و تمام تست‌ها را پاس می‌کند. اگر کد خود را به عنوان بخشی از پایپ‌لاین یکپارچه‌سازی مداوم (Continuous Integration - CI pipeline) چک‌این کنید و کد شما بیلد (build) را شکست دهد، باید حوزه‌های نگرانی مطرح شده توسط پایپ‌لاین CI را برطرف کنید. هنگامی که می‌توانید کد خود را چک‌این کنید و CI چراغ سبز را نشان می‌دهد، می‌توانید یک درخواست کشیدن (pull request) صادر کنید.

## رهبری یک بازبینی کد (Leading a code review)
هنگام رهبری بازبینی کد، مهم است که افراد مناسب حضور داشته باشند. افرادی که در بازبینی کد همتا (peer code review) حضور خواهند داشت با مدیر پروژه (project manager) توافق خواهند شد. برنامه‌نویس(ان) مسئول ارسال کد برای بازبینی، در بازبینی کد حضور خواهند داشت مگر اینکه به صورت ریموت (remotely) کار کنند. در مورد کار ریموت، بازبینی‌کننده کد را بازبینی می‌کند و یا درخواست کشیدن (pull request) را می‌پذیرد، یا آن را رد می‌کند، یا سوالاتی را برای توسعه‌دهنده ارسال می‌کند که باید قبل از هر اقدام دیگری پاسخ داده شوند.

یک رهبر مناسب برای بازبینی کد باید مهارت‌ها و دانش زیر را داشته باشد:

+ یک مرجع فنی باشد: فردی که بازبینی کد را رهبری می‌کند باید یک مرجع فنی (technical authority) باشد که دستورالعمل‌های کدنویسی شرکت (company's coding guidelines) و متدولوژی‌های توسعه نرم‌افزار (software development methodologies) را درک کند. همچنین مهم است که آن‌ها درک کلی خوبی از نرم‌افزار تحت بازبینی داشته باشند.

+ مهارت‌های نرم خوبی داشته باشد: به عنوان رهبر بازبینی کد، فرد باید یک شخص خونگرم و تشویق‌کننده باشد که بتواند بازخورد سازنده (constructive feedback) ارائه دهد. مهم است که فردی که کد برنامه‌نویس را بازبینی می‌کند مهارت‌های نرم (soft skills) خوبی داشته باشد تا هیچ تضادی (conflict) بین بازبینی‌کننده و شخصی که کدش بازبینی می‌شود، وجود نداشته باشد.

+ بیش از حد انتقادی نباشد: رهبر بازبینی کد نباید بیش از حد انتقادی (over-critical) باشد و باید بتواند انتقاد (critique) خود را از کد برنامه‌نویس توضیح دهد. مفید است اگر رهبر با سبک‌های برنامه‌نویسی مختلف (different programming styles) آشنا بوده باشد و بتواند کد را عینی (objectively) بررسی کند تا اطمینان حاصل کند که الزامات پروژه را برآورده می‌کند.

در تجربه من، بازبینی‌های کد همتا همیشه بر روی درخواست‌های کشیدن (pull requests) در ابزار کنترل نسخه (version control tool) مورد استفاده تیم انجام می‌شود. یک برنامه‌نویس کد را به کنترل نسخه (version control) ارسال می‌کند و سپس یک درخواست کشیدن صادر می‌کند. سپس بازبینی‌کننده کد همتا، کد را در درخواست کشیدن بازبینی می‌کند. بازخورد سازنده (Constructive feedback) در قالب نظراتی (comments) ارائه می‌شود که به درخواست کشیدن پیوست خواهند شد. اگر مشکلی در درخواست کشیدن وجود داشته باشد، بازبینی‌کننده درخواست تغییر (change request) را رد کرده و در مورد مسائل خاصی که باید توسط برنامه‌نویس برطرف شوند، نظر می‌دهد. اگر بازبینی کد موفقیت‌آمیز باشد، بازبینی‌کننده ممکن است نظری حاوی بازخورد مثبت (positive feedback) اضافه کند، درخواست کشیدن را ادغام (merge) کند و آن را ببندد.

برنامه‌نویسان باید هر نظر داده شده توسط بازبینی‌کننده را یادداشت کرده و آن‌ها را در نظر بگیرند. اگر کد نیاز به ارسال مجدد دارد، برنامه‌نویس باید اطمینان حاصل کند که تمام نظرات بازبینی‌کننده قبل از ارسال مجدد برطرف شده‌اند.

ایده خوبی است که بازبینی‌های کد کوتاه باشند و در هر زمان بیش از حد خط کد را بازبینی نکنید.

از آنجا که بازبینی کد معمولاً با یک درخواست کشیدن شروع می‌شود، ما به صدور یک درخواست کشیدن و سپس پاسخ به یک درخواست کشیدن خواهیم پرداخت.

## صدور درخواست کشیدن (Issuing a pull request)
هنگامی که کدنویسی را تمام کرده‌اید و از کیفیت کد خود و اینکه بیلد (builds) می‌شود اطمینان دارید، می‌توانید تغییرات خود را پوش (push) یا چک‌این (check in) کنید، بسته به اینکه از چه سیستم کنترل منبع (source control system) استفاده می‌کنید. هنگامی که کد شما پوش شده است، می‌توانید یک درخواست کشیدن (pull request) صادر کنید. هنگامی که یک درخواست کشیدن مطرح می‌شود، افراد دیگری که به کد علاقه‌مند هستند مطلع می‌شوند و می‌توانند تغییرات شما را بازبینی کنند. این تغییرات سپس می‌توانند مورد بحث قرار گیرند و نظراتی در مورد هر تغییر بالقوه‌ای که باید ایجاد کنید، ارائه شود. در اصل، پوش کردن شما به مخزن کنترل منبع (source control repository) و صدور یک درخواست کشیدن است که فرآیند بازبینی کد همتا (peer code review process) را آغاز می‌کند.

برای صدور یک درخواست کشیدن، تنها کاری که باید انجام دهید (پس از اینکه کد خود را چک‌این یا پوش کردید) این است که روی تب درخواست‌های کشیدن (Pull requests) در کنترل نسخه (version control) خود کلیک کنید. سپس دکمه‌ای وجود خواهد داشت که می‌توانید روی آن کلیک کنید – درخواست کشیدن جدید (New pull request). این کار درخواست کشیدن شما را به یک صف (queue) اضافه می‌کند تا توسط بازبینی‌کنندگان مربوطه برداشته شود.

در اسکرین‌شات‌های زیر، فرآیند درخواست و تکمیل یک درخواست کشیدن از طریق گیت‌هاب (GitHub) را خواهیم دید:
1. در صفحه پروژه گیت‌هاب خود، روی تب درخواست‌های کشیدن (Pull requests) کلیک کنید:

<div align="center">
  
  ![Conventions-UsedThis-Book](../../assets/image/02/Table%202-2.png) 
  
</div>

2. سپس، روی دکمه درخواست کشیدن جدید (New pull request) کلیک کنید. این کار صفحه مقایسه تغییرات (Comparing changes) را نمایش خواهد داد:

<div align="center">
  
  ![Conventions-UsedThis-Book](../../assets/image/02/Table%202-3.png) 
  
</div>
